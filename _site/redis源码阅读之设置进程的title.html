<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-gb">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Redis源码阅读之设置进程的Title</title>
	<meta name="author" content="bgzxz" />
	<link rel="stylesheet" href="/css/syntax.css" type="text/css" media="all" />
	<link rel="stylesheet" href="/css/screen.css" type="text/css" media="all" />
	<link rel="stylesheet" href="/css/tablet.css" type="text/css" media="screen and (min-width:651px) and (max-width: 1024px), screen and (min-device-width: 768px) and (max-device-width: 1024px)" />
	<link rel="stylesheet" href="/css/mobile.css" type="text/css" media="handheld, screen and (max-width: 650px), screen and (max-device-width: 480px)" />
</head>
<body>
	<div class="site">
		<div class="title"><a href="/">岛民的技术博客</a></div>
		<div id="post">
	<h1>Redis源码阅读之设置进程的Title</h1>
	<p class="meta">08 Aug 2013</p>
	<h2>Redis源码阅读之设置进程的Title</h2>

<p>Redis服务器在启动时会修改在ps命令中显示的cmd的显示内容(显示如下图)。</p>

<p><img src="/images/redis-setproctitle-res.png" alt="image" /></p>

<p>Redis在main函数中调用redisSetProcTitle(argv[0])方法，代码如下:</p>

<div class="highlight"><pre><code class="c"><span class="kt">void</span> <span class="nf">redisSetProcTitle</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef USE_SETPROCTITLE</span>
    <span class="n">setproctitle</span><span class="p">(</span><span class="s">&quot;%s %s:%d&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">,</span>
        <span class="n">server</span><span class="p">.</span><span class="n">bindaddr</span> <span class="o">?</span> <span class="n">server</span><span class="p">.</span><span class="n">bindaddr</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">server</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">REDIS_NOTUSED</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>


<p>setproctitle方法在setproctitle.c文件中，当os是NetBSD，FreeBSD，OpenBSD时直接调用系统的setproctitle。
当是Linux或者Mac Os时通过修改main的argv[0]的内容来改变显示的进程名称。在修改argv[0]的内容前必修先把argv和environ的内容copy到新的位置。</p>

<h2>深度探讨之Linux如何显示进程的名字</h2>

<p>在Linux下可以通过cat /proc/pid/cmdline 获取进程的cmdline。
查找Linux代码发现是通过读取程序的main函数的argv[0]来实现的，也就是上面的setproctitle的实现的原理。
代码见Linux源码目录的fs/proc/base.c文件，cmdline的 实现代码如下：</p>

<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_pid_cmdline</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">get_task_mm</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_end</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">out_mm</span><span class="p">;</span>   <span class="cm">/* Shh! No looking before we&#39;re done */</span>

    <span class="n">len</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_end</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_start</span><span class="p">;</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
 
    <span class="n">res</span> <span class="o">=</span> <span class="n">access_process_vm</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_start</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// If the nul at the end of args has been overwritten, then</span>
    <span class="c1">// assume application is using setproctitle(3).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="n">res</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">env_end</span> <span class="o">-</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">env_start</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span>
                <span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">res</span><span class="p">;</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">access_process_vm</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">env_start</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">res</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">out_mm:</span>
    <span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="nl">out:</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>




</div>

<div class="comments">
	<h3>Comments</h3>
	<noscript>Please enable JavaScript to view the comments</noscript>
	<div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    var disqus_shortname = 'bgzxz'; 
    var disqus_identifier = '/redis源码阅读之设置进程的title';
    var disqus_url = '/redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E8%AE%BE%E7%BD%AE%E8%BF%9B%E7%A8%8B%E7%9A%84title.html';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

		<div class="footer">
			<div class="contact">
				<p>
					张翔<br/>
					Java,Redis,Nodejs<br/>
					bgzxz@gmail.com
				</p>
			</div>
			<div class="contact">
				<p>
					<a href="http://github.com/bgzxz/">github.com/bgzxz</a><br />
				</p>
			</div>
			<div class="rss">
				
			</div>
		</div>
	</div>
</body>
<html>