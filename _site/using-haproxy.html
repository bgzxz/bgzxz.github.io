<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black" />
   <!-- <link rel="apple-touch-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone.png" /> -->
   <link rel="apple-touch-icon-precomposed" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-precomposed.png" />
   <link rel="apple-touch-icon" sizes="72x72" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad.png" />
   <link rel="apple-touch-icon" sizes="114x114" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-retina.png" />
   <link rel="apple-touch-icon" sizes="144x144" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad-retina.png" />
   
   <title>HAProxy配置</title>
   <meta name="author" content="Jeremy Wei" />
   <link href="http://feeds.feedburner.com/JeremyWei" rel="alternate" title="Jeremy Wei" type="application/atom+xml" />
   <link rel="shortcut icon" type="image/x-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/favicon.ico">
   
   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/syntax.css?20130623" type="text/css" />
   
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/screen.css?20130721v1" type="text/css" media="screen, projection" />
   <!-- <link rel="stylesheet" href="/css/screen.css?072122" type="text/css" media="screen, projection" /> -->
   
   <script type="text/javascript" charset="utf-8">
   // Mobile Safari in standalone mode
   if(("standalone" in window.navigator) && window.navigator.standalone){
	   
   	// If you want to prevent remote links in standalone web apps opening Mobile Safari, change 'remotes' to true
   	var noddy, remotes = true;
	
   	document.addEventListener('click', function(event) {
		
   		noddy = event.target;
		
   		// Bubble up until we hit link or top HTML element. Warning: BODY element is not compulsory so better to stop on HTML
   		while(noddy.nodeName !== "A" && noddy.nodeName !== "HTML") {
   	        noddy = noddy.parentNode;
   	    }
		
   		if('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(document.location.host) !== -1 || remotes))
   		{
   			event.preventDefault();
   			document.location.href = noddy.href;
   		}
	
   	},false);
   }
   </script>
</head>
<body>
	
<div class="site">
  <pre class="nav margin-for-mobile">{"<a href='/tech.html'>文</a>", "<a href='/translate.html'>譯</a>", "<a href='/poem.html'>詩</a>", "<a href='/5000years.html'>國史</a>", "<a href='/resume.html'>己</a>"}</pre>
  <br />
  <div id="post">
	<h1>HAProxy配置</h1>
	<div class="copyright">
	作者: JeremyWei | 可以转载, 但必须以超链接形式标明文章原始出处和作者信息及版权声明<br />
	网址: http://weizhifeng.net/using-haproxy.html
	</div>

	<h3>前言</h3>

<p><a href="http://haproxy.1wt.eu/">Haproxy</a>是一个负载均衡服务器，能够提供4层，7层代理，并能支持上万级别的连接，你可以直接在WEB服务器前端加上它，而不影响应用的访问，完全透明。</p>

<h3>安装</h3>

<pre><code>$ wget http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.8.tar.gz
$ tar -zxvf haproxy-1.4.8.tar.gz
$ cd haproxy-1.4.8
$ ./configure --prefix=/path/to/haproxy
$ make &amp;&amp; make install
</code></pre>

<h3>配置</h3>

<p>首先要添加haproxy:haproxy用户：</p>

<pre><code>$ groupadd haproxy
$ useradd -g haproxy haproxy
</code></pre>

<p>查看uid和gid</p>

<pre><code>$ sudo cat /etc/passwd |grep haproxy 
</code></pre>

<p>编辑haproxy.cfg，添加如下内容：</p>

<pre><code>global
    log 127.0.0.1   local3
    maxconn 4096            #最大连接数
    chroot /path/to/haproxy #安装目录
    uid 535  #用户haproxy
    gid 520  #组haproxy
    daemon   #守护进程运行
    nbproc 1 #进程数量
    pidfile logs/haproxy.pid

defaults

   log     127.0.0.1       local3
   mode    http       #layer 7代理
   option  httplog
   option  httpclose
   option  dontlognull
   option  forwardfor
   retries 2
   maxconn 2000
   balance roundrobin
   stats   uri     /haproxy-stats
   contimeout      5000
   clitimeout      50000
   srvtimeout      50000

frontend http-in

    bind *:80 #监听地址
    default_backend pool1

backend pool1

    option  httpchk GET /test.php #用来做健康检查
    stats refresh 2
    server server1 192.168.1.1:82 weight 3 maxconn 32 check #check表示对这个server进行健康检查
    server server2 192.168.1.2:82 weight 3 maxconn 32 check
</code></pre>

<p>查看后端server状态： http://example.com/haproxy-stats</p>

<p>启动</p>

<pre><code>$ sudo ./sbin/haproxy -f haproxy.cfg
</code></pre>

<p>重启</p>

<pre><code>$ sudo ./sbin/haproxy -f haproxy.cfg -st `cat logs/haproxy.pid`
</code></pre>

<h3>日志问题</h3>

<p>有童鞋说日志怎么也写不进去，我也遇到了这个问题，在这里分享下。 编辑<code>/etc/syslog.conf</code>文件，添加：</p>

<pre><code>local3.*    /var/log/haproxy.log
</code></pre>

<p>编辑<code>/etc/sysconfig/syslog</code>文件，把</p>

<pre><code>SYSLOGD_OPTIONS="-m 0"
</code></pre>

<p>改成</p>

<pre><code>SYSLOGD_OPTIONS="-r -m 0" #enables logging from remote machines
</code></pre>

<p>重启syslogd:</p>

<pre><code>/etc/init.d/syslog restart 
</code></pre>

<p>通过<code>tail</code>应该可以看到日志输出了：</p>

<pre><code>tail -f -n 30 /var/log/haproxy.log 
</code></pre>

<h3>参考：</h3>

<p><a href="http://blog.chenlb.com/2009/06/install-haproxy-and-configure-load-balance.html">http://blog.chenlb.com/2009/06/install-haproxy-and-configure-load-balance.html</a>  <br/>
<a href="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt">http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</a></p>

	(完)

	<div class="post-info">
		26 Mar 2011  
	
		
	
		
	</div>
	
	<!-- disqus start -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	    var disqus_shortname = 'jeremywei'; // required: replace example with your forum shortname

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- disqus end -->

	<!-- related start -->
	<div id="related">
	  <h2>相关内容</h2>
	  <ul class="posts">
	    
	      <li><span>21 Jul 2013</span> &raquo; <a href="/viewports.html">两个viewport的故事（第一部分）</a></li>
	    
	      <li><span>14 Jul 2013</span> &raquo; <a href="/a-pixel-is-not.html">不是像素的像素不是像素</a></li>
	    
	      <li><span>06 Jul 2013</span> &raquo; <a href="/make-web-app-more-native.html">把你的网站改造成一个iOS Web App</a></li>
	    
	      <li><span>06 Jul 2013</span> &raquo; <a href="/cross-browser-inline-block.html">跨浏览器的Inline-Block</a></li>
	    
	      <li><span>30 Jun 2013</span> &raquo; <a href="/css-underscore-hack.html">The Underscore Hack</a></li>
	    
	  </ul>
	</div>
	<!-- related end -->
</div>
  
<div class="footer"></div>
<div class="power">  
  Powered by <a href="http://github.com/" targe="_blank">Github</a> &nbsp;&amp;&amp;&nbsp; <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> 
</div>
</div>

<a href="http://github.com/jeremywei" target="_blank">
	<img class="right-banner first" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>

<a href="http://www.phptherightway.com" target="_blank">
    <img class="right-banner second" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/php-the-right-way-120x60.png" alt="PHP: The Right Way"/>
</a>
</body>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5179718-7']);
  _gaq.push(['_setDomainName', 'weizhifeng.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
