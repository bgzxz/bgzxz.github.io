<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black" />
   <!-- <link rel="apple-touch-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone.png" /> -->
   <link rel="apple-touch-icon-precomposed" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-precomposed.png" />
   <link rel="apple-touch-icon" sizes="72x72" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad.png" />
   <link rel="apple-touch-icon" sizes="114x114" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-retina.png" />
   <link rel="apple-touch-icon" sizes="144x144" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad-retina.png" />
   
   <title>Pagespeed优化准则之减少请求开销</title>
   <meta name="author" content="Jeremy Wei" />
   <link href="http://feeds.feedburner.com/JeremyWei" rel="alternate" title="Jeremy Wei" type="application/atom+xml" />
   <link rel="shortcut icon" type="image/x-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/favicon.ico">
   
   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/syntax.css?20130623" type="text/css" />
   
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/screen.css?20130721v1" type="text/css" media="screen, projection" />
   <!-- <link rel="stylesheet" href="/css/screen.css?072122" type="text/css" media="screen, projection" /> -->
   
   <script type="text/javascript" charset="utf-8">
   // Mobile Safari in standalone mode
   if(("standalone" in window.navigator) && window.navigator.standalone){
	   
   	// If you want to prevent remote links in standalone web apps opening Mobile Safari, change 'remotes' to true
   	var noddy, remotes = true;
	
   	document.addEventListener('click', function(event) {
		
   		noddy = event.target;
		
   		// Bubble up until we hit link or top HTML element. Warning: BODY element is not compulsory so better to stop on HTML
   		while(noddy.nodeName !== "A" && noddy.nodeName !== "HTML") {
   	        noddy = noddy.parentNode;
   	    }
		
   		if('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(document.location.host) !== -1 || remotes))
   		{
   			event.preventDefault();
   			document.location.href = noddy.href;
   		}
	
   	},false);
   }
   </script>
</head>
<body>
	
<div class="site">
  <pre class="nav margin-for-mobile">{"<a href='/tech.html'>文</a>", "<a href='/translate.html'>譯</a>", "<a href='/poem.html'>詩</a>", "<a href='/5000years.html'>國史</a>", "<a href='/resume.html'>己</a>"}</pre>
  <br />
  <div id="post">
	<h1>Pagespeed优化准则之减少请求开销</h1>
	<div class="copyright">
	作者: JeremyWei | 可以转载, 但必须以超链接形式标明文章原始出处和作者信息及版权声明<br />
	网址: http://weizhifeng.net/pagespeed-minimize-request-overhead.html
	</div>

	<p>当客户端发送一个HTTP请求的时候，给这个域名和path设置的cookie也会随同一次发送。大多数用户的网络带宽是不对称的，上传和下载之间 的比例是1:4到1:20之间。这就是说发送一个500B的HTTP头和下载一个10KB的HTTP响应花费的时间是一样的。有的时候情况会更糟，因为 HTTP头是没有经过压缩的。在一个新的浏览器会话开始的时候，这个延迟会更大。为了避免网络拥堵，TCP会使用slow start的算法来创建新的连接。浏览器在发送新数据之前需要等待服务器返回对已经发送数据的ACK响应，这就限制了数据的发送量。如果需要发送的数据超过了一个连接一次能发送的最大量，那么数据就会分批发送，从而增加了浏览器和服务器之间交互的时间，即RTT。缩短请求时间的方法是减少请求的字节数，比如说HTTP头。</p>

<h2>最小化请求大小(Minimize request size)</h2>

<h3>概述</h3>

<p>尽可能保持cookie和请求头要小，确保一个HTTP请求可以通过一个TCP包传输完成。</p>

<h3>详细</h3>

<p>理想情况下，一个HTTP请求不会用超过1个packet来传输。大多数使用范围很广的网络会限制一个packet最多能传输1500个字节；所以，如果可以把每个请求限制在1500个字节之内，那么就减少请求的开销。</p>

<p>HTTP请求头包括：</p>

<ul>
<li>Cookie: 对于需要cookie的资源，要保证cookie最小。为了使HTTP请求的数据少，对于一个域名不允许设置大于1000个字节的cookie，推荐所有cookie的平均大小小于400个字节。</li>
<li>浏览器设置的头：有些HTTP头是浏览器自动设置的，这个无法控制。</li>
<li>请求资源的URL(GET和Host字段)：拥有太多参数的URL会造成很大的请求数据量，请精简URL。</li>
<li>Referrer URL</li>
</ul>


<h3>建议</h3>

<ol>
<li><p>用服务端存储来节省cookie带来的负载 (Use server-side storage for most of the cookie payload.)
在cookie里存储一个唯一的标识符，然后用这个ID和服务器端的数据进行关联，一些需要存在cookie里的内容，可以在服务器端找到，从而减小了cookie的大小。</p></li>
<li><p>删除无用或者重复的cookie字段 (Remove unused or duplicated cookie fields)
如果cookie被设置在一个域名的顶级路径下，比如”/”，那么这个域名下所有路径都会继承这个cookie。如果想要在不同的路径中使用同一个 cookie，那么可以在顶级路径下面设置这个cookie，不需要在子路径下设置重复的cookie。如果只需要在子路径中使用一个cookie，那么 不要在顶级路径中设置这个cookie，因为这样会导致cookie会发送到不需要此cookie的路径中，造成不必要的流量。</p></li>
</ol>


<h2>使用cookie无关的域名来传输静态内容 (Serve static content from a cookieless domain)</h2>

<h3>概述</h3>

<p>使用一个cookie无关的域名来传输静态资源，可以减少页面总体的流量。</p>

<h3>详细</h3>

<p>静态的内容，例如图片，JS，CSS等，不需要传递cookie，因为没有用户会与这些资源进行交互。可以使用cookie无关的域名来传输静态资源，这 样可以降低请求的延迟。这个技术对于其中包含大量很难被缓存的内容的页面特别有效，比如经常修改的缩略图或者不经常被访问的图片。对于页面中包含超过5个静态资源的页面推荐使用这种技术，如果少于5个，那么不值得这么做。如果想使用cookie无关的域名来传输静态资源，需要注册一个域名，然后添加 CNAME记录，并指向到已经存在的A记录上。调整程序，使所有的静态资源都通过cookie无关的域名进行传输。</p>

<h3>建议</h3>

<ol>
<li><p>开启代理缓存 (Enable proxy caching)
对于很难改变的内容，设置浏览器和代理缓存。由于这些资源不会附带cookie，所以不用担心代理服务器会缓存用户的数据。</p></li>
<li><p>不要用cookie无关的域名来传输外部JS (Don’t serve early loaded external JS files from the cookieless domain)
在HTML文档头部引入并且页面渲染所需要的外部JavaScript文件，应该使用和页面一样的域名来传输，而不是使用cookie无关的新域名，因为 浏览器会阻塞JavaScript后面其他的资源下载，直到所有的JavaScript完成下载，解析，执行。所以如果使用cookie无关的域名则可能 会增加额外的DNS查询的时间。</p></li>
</ol>


<p>原文：<a href="http://code.google.com/speed/page-speed/docs/request.html">http://code.google.com/speed/page-speed/docs/request.html</a></p>

	(完)

	<div class="post-info">
		26 Mar 2011  
	
		
	
		
	</div>
	
	<!-- disqus start -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	    var disqus_shortname = 'jeremywei'; // required: replace example with your forum shortname

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- disqus end -->

	<!-- related start -->
	<div id="related">
	  <h2>相关内容</h2>
	  <ul class="posts">
	    
	      <li><span>21 Jul 2013</span> &raquo; <a href="/viewports.html">两个viewport的故事（第一部分）</a></li>
	    
	      <li><span>14 Jul 2013</span> &raquo; <a href="/a-pixel-is-not.html">不是像素的像素不是像素</a></li>
	    
	      <li><span>06 Jul 2013</span> &raquo; <a href="/make-web-app-more-native.html">把你的网站改造成一个iOS Web App</a></li>
	    
	      <li><span>06 Jul 2013</span> &raquo; <a href="/cross-browser-inline-block.html">跨浏览器的Inline-Block</a></li>
	    
	      <li><span>30 Jun 2013</span> &raquo; <a href="/css-underscore-hack.html">The Underscore Hack</a></li>
	    
	  </ul>
	</div>
	<!-- related end -->
</div>
  
<div class="footer"></div>
<div class="power">  
  Powered by <a href="http://github.com/" targe="_blank">Github</a> &nbsp;&amp;&amp;&nbsp; <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> 
</div>
</div>

<a href="http://github.com/jeremywei" target="_blank">
	<img class="right-banner first" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>

<a href="http://www.phptherightway.com" target="_blank">
    <img class="right-banner second" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/php-the-right-way-120x60.png" alt="PHP: The Right Way"/>
</a>
</body>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5179718-7']);
  _gaq.push(['_setDomainName', 'weizhifeng.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
